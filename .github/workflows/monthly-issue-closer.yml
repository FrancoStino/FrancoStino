name: Monthly Issue Closer

on:
  schedule:
    # Esegui il primo giorno di ogni mese alle 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch: # Permetti esecuzione manuale

permissions:
  issues: write
  contents: read

jobs:
  close-monthly-issues:
    runs-on: ubuntu-latest
    
    steps:
      - name: Close all open issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Cercando issue aperte..."
          
          ISSUES=$(gh issue list --repo ${{ github.repository }} --state open --json number --jq '.[] | .number')
          
          if [ -z "$ISSUES" ]; then
            echo "âœ… Nessuna issue aperta trovata"
            exit 0
          fi
          
          ISSUE_COUNT=$(echo "$ISSUES" | wc -l)
          echo "ðŸ“Š Trovate $ISSUE_COUNT issue aperte"
          
          CURRENT_DATE=$(date '+%Y-%m-%d')
          
          for ISSUE_NUMBER in $ISSUES; do
            echo "ðŸ”’ Chiudendo issue #$ISSUE_NUMBER..."
            
            COMMENT="ðŸ¤– Chiusura automatica mensile
          
          Questa issue Ã¨ stata chiusa automaticamente il $CURRENT_DATE come parte della pulizia mensile del repository.
          
          Se questa issue richiede ancora attenzione, sentiti libero di riaprirla."
            
            gh issue close "$ISSUE_NUMBER" --repo ${{ github.repository }} --comment "$COMMENT"
            
            if [ $? -eq 0 ]; then
              echo "âœ… Issue #$ISSUE_NUMBER chiusa con successo"
            else
              echo "âŒ Errore nella chiusura dell'issue #$ISSUE_NUMBER"
            fi
            
            sleep 2
          done
          
          echo "ðŸŽ‰ Completata la chiusura di tutte le issue!"

      - name: Create summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“‹ Creando issue di riepilogo..."
          
          CLOSED_COUNT=$(gh issue list --repo ${{ github.repository }} --state closed --search "closed:>=$(date -d '1 day ago' '+%Y-%m-%d')" --json number --jq '. | length')
          
          MONTH_NAME=$(date '+%B %Y')
          CURRENT_DATE=$(date '+%d/%m/%Y %H:%M:%S')
          NEXT_DATE=$(date -d '+1 month' '+%d/%m/%Y')
          
          SUMMARY="Riepilogo Chiusura Mensile Issue - $CURRENT_DATE
          
          Issue chiuse: $CLOSED_COUNT
          Prossima esecuzione: $NEXT_DATE
          
          Tutte le issue aperte sono state chiuse automaticamente."
          
          gh issue create --repo ${{ github.repository }} --title "ðŸ“Š Riepilogo Mensile - $MONTH_NAME" --body "$SUMMARY" --label "automation"
          
          echo "âœ… Issue di riepilogo creata"
