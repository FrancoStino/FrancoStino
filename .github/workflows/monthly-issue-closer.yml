name: Monthly Issue Closer

on:
  schedule:
    # Esegui il primo giorno di ogni mese alle 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch: # Permetti esecuzione manuale

permissions:
  issues: write
  contents: read

jobs:
  close-monthly-issues:
    runs-on: ubuntu-latest
    
    steps:
      - name: Close all open issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Cercando issue aperte..."
          
          ISSUES=$(gh issue list --repo ${{ github.repository }} --state open --json number --jq '.[] | .number')
          
          if [ -z "$ISSUES" ]; then
            echo "‚úÖ Nessuna issue aperta trovata"
            exit 0
          fi
          
          ISSUE_COUNT=$(echo "$ISSUES" | wc -l)
          echo "üìä Trovate $ISSUE_COUNT issue aperte"
          
          CURRENT_DATE=$(date '+%Y-%m-%d')
          
          for ISSUE_NUMBER in $ISSUES; do
            echo "üîí Chiudendo issue #$ISSUE_NUMBER..."
            
            COMMENT="ü§ñ Chiusura automatica mensile
          
          Questa issue √® stata chiusa automaticamente il $CURRENT_DATE come parte della pulizia mensile del repository.
          
          Se questa issue richiede ancora attenzione, sentiti libero di riaprirla."
            
            gh issue close "$ISSUE_NUMBER" --repo ${{ github.repository }} --comment "$COMMENT"
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ Issue #$ISSUE_NUMBER chiusa con successo"
            else
              echo "‚ùå Errore nella chiusura dell'issue #$ISSUE_NUMBER"
            fi
            
            sleep 2
          done
          
          echo "üéâ Completata la chiusura di tutte le issue!"
          
