name: GitHub Readme CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.title, 'Update')) ||
      (github.event_name != 'issues' && github.actor != 'github-actions[bot]' && 
      !contains(github.event.head_commit.message, 'Auto-update: GitHub Stats'))
    outputs:
      pr_number_before: ${{ steps.create-pr-before.outputs.pr_number }}
      issue_number: ${{ steps.get-issue.outputs.issue_number }}

    env:
      GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}

    steps:
      - name: 0. Get Issue Number
        id: get-issue
        run: |
          if [ "${{ github.event_name }}" == "issues" ]; then
            echo "issue_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "issue_number=" >> "$GITHUB_OUTPUT"
          fi

      - name: 1. Checkout Main Branch
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.WORKFLOW_TOKEN }}
          fetch-depth: 0

      - name: 2. Create develop branch if not exists
        run: |
          git fetch origin
          if ! git rev-parse --verify origin/develop >/dev/null 2>&1; then
            git checkout -b develop
            git push origin develop
          fi
          git checkout develop
          git pull origin develop

      - name: 3. Create before-pull branch if not exists
        run: |
          git fetch origin
          if ! git rev-parse --verify origin/before-pull >/dev/null 2>&1; then
            git checkout -b before-pull
            git push origin before-pull
          fi
          git checkout before-pull
          git pull origin before-pull

      - name: 4. Create assets directory if not exists
        run: |
          if [ ! -d "assets" ]; then
            mkdir -p assets
            echo "# Assets Directory" > assets/README.md
            echo "This directory contains auto-generated GitHub stats and visualizations." >> assets/README.md
          fi

      - name: 5. Generate GitHub Contributions Snake Animations
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            assets/github-snake.svg?color_snake=orange&color_dots=#bfd6f6,#8dbdff,#64a1f4,#4b91f1,#3c7dd9
            assets/github-snake-dark.svg?palette=github-dark&color_snake=#cca835&color_dots=#161b22,#1e415e,#2b5b84,#3b78a3,#4b91f1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 6. Fetch GitHub Trophies
        run: |
          curl -f --connect-timeout 30 --retry 3 --retry-delay 5 \
            -o "./assets/github-trophies.svg" \
            "https://github-profile-trophy.vercel.app/?username=${{ github.repository_owner }}&theme=onedark&no-frame=true&no-bg=true&margin-w=10&column=3" \
            || echo "Failed to fetch Trophies."

      - name: 7. Fetch GitHub Stats
        run: |
          curl -f --connect-timeout 30 --retry 3 --retry-delay 5 \
            -o "./assets/github-stats.svg" \
            "https://github-readme-stats-rose-eight-73.vercel.app/api?username=${{ github.repository_owner }}&show_icons=true&include_all_commits=true&theme=tokyonight&show=reviews,prs_merged&count_private=true" \
            || echo "Failed to fetch GitHub Stats."

      - name: 8. Fetch Top Languages
        run: |
          curl -f --connect-timeout 30 --retry 3 --retry-delay 5 \
            -o "./assets/top-languages.svg" \
            "https://github-readme-stats-rose-eight-73.vercel.app/api/top-langs/?username=${{ github.repository_owner }}&langs_count=10&layout=compact&theme=tokyonight&hide_border=false&include_all_commits=true&count_private=true" \
            || echo "Failed to fetch Top Languages."

      - name: 9. Fetch GitHub Streak
        run: |
          curl -f --connect-timeout 30 --retry 3 --retry-delay 5 \
            -o "./assets/github-streak.svg" \
            "https://github-readme-streak-stats.herokuapp.com/?user=${{ github.repository_owner }}&theme=tokyonight&hide_border=false" \
            || echo "Failed to fetch GitHub Streak."

      - name: 10. Fetch Activity Graph
        run: |
          curl -f --connect-timeout 30 --retry 3 --retry-delay 5 \
            -o "./assets/activity-graph.svg" \
            "https://github-readme-activity-graph.vercel.app/graph?username=${{ github.repository_owner }}&custom_title=âš¡%20Activity%20Graph&days=30&area=true&radius=8&hide_border=true&height=350&theme=react-dark&bg_color=050608&color=ffffff&title_color=ffffff&line=3572a5&point=ffffff&area_color=3572a5" \
            || echo "Failed to fetch Activity Graph."

      - name: 11. Configure Git
        run: |
          git config --local user.email "info@davideladisa.it"
          git config --local user.name "Davide Ladisa"

      - name: 12. Commit all assets to before-pull
        run: |
          git add assets/
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ¤– Auto-update: GitHub Stats & Visualizations"
            git push origin before-pull
          else
            echo "No changes to commit"
          fi

      - name: 13. Create First PR (before-pull to develop)
        id: create-pr-before
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Funzione di retry
          retry_command() {
            local max_attempts=5
            local timeout=30
            local attempt=1
            local exitCode=0
            
            while (( attempt <= max_attempts )); do
              echo "Attempt $attempt of $max_attempts..." >&2
              if timeout $timeout "$@"; then
                return 0
              else
                exitCode=$?
                if (( attempt < max_attempts )); then
                  echo "Command failed, waiting 10 seconds before retry..." >&2
                  sleep 10
                fi
              fi
              ((attempt++))
            done
            
            return $exitCode
          }
          
          echo "Checking for existing PR..."
          EXISTING_PR=$(retry_command gh pr list --base develop --head before-pull --json number --jq '.[0].number // empty')
          
          if [ -z "$EXISTING_PR" ]; then
            ISSUE_REF=""
            if [ -n "${{ steps.get-issue.outputs.issue_number }}" ]; then
              ISSUE_REF="Closes #${{ steps.get-issue.outputs.issue_number }}"
            fi
            
            PR_BODY="Aggiornamento automatico delle statistiche GitHub.
          
          $ISSUE_REF
          
          Questa PR contiene:
          - ðŸ Snake animations
          - ðŸ† GitHub trophies
          - ðŸ“Š GitHub stats
          - âŒ¨ï¸ Top languages
          - ðŸ”¥ GitHub streak
          - âš¡ Activity graph"
            
            echo "Creating new PR..."
            retry_command gh pr create \
              --base develop \
              --head before-pull \
              --title "ðŸ”„ First Update: Stats to Develop" \
              --body "$PR_BODY"
          
            echo "Getting PR number..."
            PR_NUMBER=$(retry_command gh pr list --base develop --head before-pull --json number --jq '.[0].number')
            echo "PR created: #$PR_NUMBER"
            
            echo "Assigning PR to repository owner..."
            retry_command gh pr edit "$PR_NUMBER" --add-assignee "${{ github.repository_owner }}"
            
          else
            PR_NUMBER=$EXISTING_PR
            echo "Using existing PR #$PR_NUMBER"
          fi
          
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

  review-and-merge-first-pr:
    needs: generate
    if: needs.generate.outputs.pr_number_before != ''
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Review and approve first PR
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
        run: |
          # Funzione di retry
          retry_command() {
            local max_attempts=5
            local timeout=30
            local attempt=1
            local exitCode=0
            
            while (( attempt <= max_attempts )); do
              echo "Attempt $attempt of $max_attempts..." >&2
              if timeout $timeout "$@"; then
                return 0
              else
                exitCode=$?
                if (( attempt < max_attempts )); then
                  echo "Command failed, waiting 10 seconds before retry..." >&2
                  sleep 10
                fi
              fi
              ((attempt++))
            done
            
            return $exitCode
          }
          
          PR_NUMBER="${{ needs.generate.outputs.pr_number_before }}"
          
          echo "Approving PR #$PR_NUMBER..."
          retry_command gh pr review "$PR_NUMBER" --approve --body "âœ… Reviewed and approved automatically"
          
          echo "Waiting for PR to be mergeable..."
          sleep 10
          
          echo "Merging PR #$PR_NUMBER..."
          retry_command gh pr merge "$PR_NUMBER" --merge --subject "Merge PR #$PR_NUMBER: Stats update [skip ci]"
          echo "âœ… First PR #$PR_NUMBER merged successfully"
