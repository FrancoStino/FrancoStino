name: GitHub Readme CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.title, 'Update')) ||
      (github.event_name != 'issues' && github.actor != 'github-actions[bot]' && !contains(github.event.head_commit.message, 'Auto-update: GitHub Stats'))
    
    outputs:
      pr_number_before: ${{ steps.create-pr-before.outputs.pr_number }}
      pr_number_main: ${{ steps.create-pr-main.outputs.pr_number }}
      issue_number: ${{ steps.create-issue.outputs.issue_number }}
    
    env:
      GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
    
    steps:
      - name: 0. Checkout Main Branch
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.WORKFLOW_TOKEN }}
          fetch-depth: 0

      - name: 1. Create Issue
        id: create-issue
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
        run: |
          # Funzione di retry
          retry_command() {
            local max_attempts=5
            local timeout=30
            local attempt=1
            local exitCode=0
            
            while (( attempt <= max_attempts )); do
              echo "Attempt $attempt of $max_attempts..." >&2
              if timeout $timeout "$@"; then
                return 0
              else
                exitCode=$?
                if (( attempt < max_attempts )); then
                  echo "Command failed, waiting 10 seconds before retry..." >&2
                  sleep 10
                fi
              fi
              ((attempt++))
            done
            
            return $exitCode
          }
          
          # Se l'evento √® gi√† un'issue, usa quella esistente
          if [ "${{ github.event_name }}" == "issues" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            echo "Using existing issue #$ISSUE_NUMBER"
          else
            # Crea una nuova issue
            ISSUE_BODY="ü§ñ Aggiornamento automatico delle statistiche GitHub
          
          Questo aggiornamento include:
          - üêç Snake animations
          - üèÜ GitHub trophies
          - üìä GitHub stats
          - ‚å®Ô∏è Top languages
          - üî• GitHub streak
          
          ---
          *Issue creata automaticamente dal workflow*"
          
            echo "Creating new issue..."
            ISSUE_URL=$(retry_command gh issue create \
              --title "üîÑ Update GitHub Stats & Visualizations" \
              --body "$ISSUE_BODY" \
              --assignee "FrancoStino")
            
            # Estrai il numero dell'issue dall'URL
            ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oP '\d+$')
            echo "Issue created: #$ISSUE_NUMBER"
          fi
          
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"

      - name: 2. Create develop branch if not exists
        run: |
          git fetch origin
          if ! git rev-parse --verify origin/develop >/dev/null 2>&1; then
            git checkout -b develop
            git push origin develop
          fi
          git checkout develop
          git pull origin develop

      - name: 3. Create before-pull branch if not exists
        run: |
          git fetch origin
          if ! git rev-parse --verify origin/before-pull >/dev/null 2>&1; then
            git checkout -b before-pull
            git push origin before-pull
          fi
          git checkout before-pull
          git pull origin before-pull

      - name: 4. Create assets directory if not exists
        run: |
          if [ ! -d "assets" ]; then
            mkdir -p assets
            echo "# Assets Directory" > assets/README.md
            echo "This directory contains auto-generated GitHub stats and visualizations." >> assets/README.md
          fi

      - name: 5. Generate GitHub Contributions Snake Animations
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            assets/github-snake.svg?color_snake=orange&color_dots=#bfd6f6,#8dbdff,#64a1f4,#4b91f1,#3c7dd9
            assets/github-snake-dark.svg?palette=github-dark&color_snake=#cca835&color_dots=#161b22,#1e415e,#2b5b84,#3b78a3,#4b91f1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 6. Fetch GitHub Trophies
        run: |
          curl -f --connect-timeout 30 --retry 3 --retry-delay 5 \
            -o "./assets/github-trophies.svg" \
            "https://github-profile-trophy.vercel.app/?username=${{ github.repository_owner }}&theme=onedark&no-frame=true&no-bg=true&margin-w=10&column=3" \
            || echo "Failed to fetch Trophies."

      - name: 7. Fetch GitHub Stats
        run: |
          curl -f --connect-timeout 30 --retry 3 --retry-delay 5 \
            -o "./assets/github-stats.svg" \
            "https://github-readme-stats-rose-eight-73.vercel.app/api?username=${{ github.repository_owner }}&show_icons=true&include_all_commits=true&theme=tokyonight&show=reviews,prs_merged&count_private=true" \
            || echo "Failed to fetch GitHub Stats."

      - name: 8. Fetch Top Languages
        run: |
          curl -f --connect-timeout 30 --retry 3 --retry-delay 5 \
            -o "./assets/top-languages.svg" \
            "https://github-readme-stats-rose-eight-73.vercel.app/api/top-langs/?username=${{ github.repository_owner }}&langs_count=10&layout=compact&theme=tokyonight&hide_border=false&include_all_commits=true&count_private=true" \
            || echo "Failed to fetch Top Languages."

      - name: 9. Fetch GitHub Streak
        run: |
          curl -f --connect-timeout 30 --retry 3 --retry-delay 5 \
            -o "./assets/github-streak.svg" \
            "https://github-readme-streak-stats.herokuapp.com/?user=${{ github.repository_owner }}&theme=tokyonight&hide_border=false" \
            || echo "Failed to fetch GitHub Streak."

      - name: 11. Configure Git
        run: |
          git config --local user.email "info@davideladisa.it"
          git config --local user.name "FrancoStino"

      - name: 12. Commit all assets to before-pull
        run: |
          git add assets/
          if ! git diff --staged --quiet; then
            git commit -m "ü§ñ Auto-update: GitHub Stats & Visualizations"
            # Force push per evitare conflitti di merge
            git push --force origin before-pull
          else
            echo "No changes to commit"
          fi

      - name: 13. Create First PR (before-pull to develop)
        id: create-pr-before
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Funzione di retry
          retry_command() {
            local max_attempts=5
            local timeout=30
            local attempt=1
            local exitCode=0
            
            while (( attempt <= max_attempts )); do
              echo "Attempt $attempt of $max_attempts..." >&2
              if timeout $timeout "$@"; then
                return 0
              else
                exitCode=$?
                if (( attempt < max_attempts )); then
                  echo "Command failed, waiting 10 seconds before retry..." >&2
                  sleep 10
                fi
              fi
              ((attempt++))
            done
            
            return $exitCode
          }
          
          echo "Checking for existing PR..."
          EXISTING_PR=$(retry_command gh pr list --base develop --head before-pull --json number --jq '.[0].number // empty')
          
          if [ -z "$EXISTING_PR" ]; then
            ISSUE_NUMBER="${{ steps.create-issue.outputs.issue_number }}"
            PR_BODY="Aggiornamento automatico delle statistiche GitHub.
          
          Closes #${ISSUE_NUMBER}
          
          Questa PR contiene:
          - üêç Snake animations
          - üèÜ GitHub trophies
          - üìä GitHub stats
          - ‚å®Ô∏è Top languages
          - üî• GitHub streak"
          
            echo "Creating new PR..."
            retry_command gh pr create \
              --base develop \
              --head before-pull \
              --title "üîÑ First Update: Stats to Develop" \
              --body "$PR_BODY"
            
            echo "Getting PR number..."
            PR_NUMBER=$(retry_command gh pr list --base develop --head before-pull --json number --jq '.[0].number')
            echo "PR created: #$PR_NUMBER"
            
            echo "Assigning PR to repository owner..."
            retry_command gh pr edit "$PR_NUMBER" --add-assignee "${{ github.repository_owner }}"
          else
            PR_NUMBER=$EXISTING_PR
            echo "Using existing PR #$PR_NUMBER"
          fi
          
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: 14. Checkout develop branch
        run: |
          git checkout develop
          git pull origin develop

      - name: 15. Create Second PR (develop to main)
        id: create-pr-main
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
        run: |
          # Funzione di retry
          retry_command() {
            local max_attempts=5
            local timeout=30
            local attempt=1
            local exitCode=0
            
            while (( attempt <= max_attempts )); do
              echo "Attempt $attempt of $max_attempts..." >&2
              if timeout $timeout "$@"; then
                return 0
              else
                exitCode=$?
                if (( attempt < max_attempts )); then
                  echo "Command failed, waiting 10 seconds before retry..." >&2
                  sleep 10
                fi
              fi
              ((attempt++))
            done
            
            return $exitCode
          }
          
          echo "Checking for existing PR..."
          EXISTING_PR=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number // empty' 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            PR_NUMBER=$EXISTING_PR
            echo "Using existing PR #$PR_NUMBER"
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # Verifica se ci sono commit da mergiare
          git fetch origin main develop
          COMMITS_AHEAD=$(git rev-list --count origin/main..origin/develop 2>/dev/null || echo "0")
          
          if [ "$COMMITS_AHEAD" = "0" ]; then
            echo "‚ö†Ô∏è No commits between main and develop, skipping PR creation"
            echo "pr_number=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "Creating new PR ($COMMITS_AHEAD commits ahead)..."
          
          # Prova a creare la PR, gestendo l'errore se esiste gi√†
          if PR_URL=$(gh pr create \
            --base main \
            --head develop \
            --title "ü§ñ Auto-update: GitHub Stats & Visualizations" \
            --body "Aggiornamento automatico da develop a main" 2>&1); then
            
            echo "Getting PR number..."
            PR_NUMBER=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number')
            echo "PR created: #$PR_NUMBER"
            
            echo "Assigning PR to FrancoStino..."
            retry_command gh pr edit "$PR_NUMBER" --add-assignee FrancoStino
            
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          else
            # Se la PR esiste gi√†, estrai il numero dall'errore
            if echo "$PR_URL" | grep -q "already exists"; then
              EXISTING_PR_URL=$(echo "$PR_URL" | grep -oP 'https://[^\s]+' | head -1)
              PR_NUMBER=$(echo "$EXISTING_PR_URL" | grep -oP '\d+$')
              echo "PR already exists: #$PR_NUMBER"
              echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            else
              echo "‚ö†Ô∏è Failed to create PR: $PR_URL"
              echo "pr_number=" >> "$GITHUB_OUTPUT"
            fi
          fi

  review-and-merge-first-pr:
    needs: generate
    if: needs.generate.outputs.pr_number_before != ''
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.WORKFLOW_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --local user.email "info@davideladisa.it"
          git config --local user.name "FrancoStino"

      - name: Resolve conflicts and merge PR
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
        run: |
          PR_NUMBER="${{ needs.generate.outputs.pr_number_before }}"
          
          # Verifica lo stato della PR
          PR_STATE=$(gh pr view "$PR_NUMBER" --json state --jq '.state')
          echo "PR #$PR_NUMBER state: $PR_STATE"
          
          if [ "$PR_STATE" = "MERGED" ]; then
            echo "‚úÖ PR #$PR_NUMBER is already merged, skipping..."
            exit 0
          fi
          
          if [ "$PR_STATE" = "CLOSED" ]; then
            echo "‚ö†Ô∏è PR #$PR_NUMBER is already closed, skipping..."
            exit 0
          fi
          
          echo "Approving PR #$PR_NUMBER..."
          gh pr review "$PR_NUMBER" --approve --body "‚úÖ Reviewed and approved automatically" || true
          
          # Checkout develop e merge before-pull con strategia theirs per assets
          git fetch origin
          git checkout develop
          git pull origin develop
          
          echo "Merging before-pull into develop with conflict resolution..."
          if ! git merge origin/before-pull --no-edit -m "Merge PR #$PR_NUMBER: Stats update [skip ci]"; then
            echo "‚ö†Ô∏è Merge conflicts detected, resolving..."
            
            # Risolvi conflitti accettando sempre le modifiche da before-pull per i file assets
            git checkout --theirs assets/
            git add assets/
            
            # Completa il merge
            git commit --no-edit -m "Merge PR #$PR_NUMBER: Stats update [skip ci]"
          fi
          
          # Push delle modifiche
          git push origin develop
          
          # Verifica nuovamente lo stato prima di chiudere
          PR_STATE_AFTER=$(gh pr view "$PR_NUMBER" --json state --jq '.state')
          
          if [ "$PR_STATE_AFTER" = "OPEN" ]; then
            echo "Closing PR #$PR_NUMBER..."
            gh pr close "$PR_NUMBER" --comment "‚úÖ Merged manually with conflict resolution" --delete-branch=false
          else
            echo "‚úÖ PR #$PR_NUMBER already merged/closed"
          fi
          
          echo "‚úÖ Merge process completed successfully"

  auto-merge-second-pr:
    needs: [generate, review-and-merge-first-pr]
    if: needs.generate.outputs.pr_number_main != ''
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Auto-merge second PR
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
        run: |
          # Funzione di retry
          retry_command() {
            local max_attempts=5
            local timeout=30
            local attempt=1
            local exitCode=0
            
            while (( attempt <= max_attempts )); do
              echo "Attempt $attempt of $max_attempts..." >&2
              if timeout $timeout "$@"; then
                return 0
              else
                exitCode=$?
                if (( attempt < max_attempts )); then
                  echo "Command failed, waiting 10 seconds before retry..." >&2
                  sleep 10
                fi
              fi
              ((attempt++))
            done
            
            return $exitCode
          }
          
          PR_NUMBER="${{ needs.generate.outputs.pr_number_main }}"
          
          # Verifica lo stato della PR
          PR_STATE=$(gh pr view "$PR_NUMBER" --json state --jq '.state' 2>/dev/null || echo "UNKNOWN")
          echo "PR #$PR_NUMBER state: $PR_STATE"
          
          if [ "$PR_STATE" = "MERGED" ]; then
            echo "‚úÖ PR #$PR_NUMBER is already merged, skipping..."
            exit 0
          fi
          
          if [ "$PR_STATE" = "CLOSED" ]; then
            echo "‚ö†Ô∏è PR #$PR_NUMBER is already closed, skipping..."
            exit 0
          fi
          
          echo "Waiting for PR #$PR_NUMBER to be mergeable..."
          sleep 10
          
          echo "Merging PR #$PR_NUMBER..."
          retry_command gh pr merge "$PR_NUMBER" --merge --subject "Merge pull request #$PR_NUMBER [skip ci]"
          
          echo "‚úÖ Second PR #$PR_NUMBER merged successfully"

      - name: Close issue after successful merge
        if: success()
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
        run: |
          # Funzione di retry
          retry_command() {
            local max_attempts=5
            local timeout=30
            local attempt=1
            local exitCode=0
            
            while (( attempt <= max_attempts )); do
              echo "Attempt $attempt of $max_attempts..." >&2
              if timeout $timeout "$@"; then
                return 0
              else
                exitCode=$?
                if (( attempt < max_attempts )); then
                  echo "Command failed, waiting 10 seconds before retry..." >&2
                  sleep 10
                fi
              fi
              ((attempt++))
            done
            
            return $exitCode
          }
          
          ISSUE_NUMBER="${{ needs.generate.outputs.issue_number }}"
          
          if [ -n "$ISSUE_NUMBER" ]; then
            echo "Closing issue #$ISSUE_NUMBER..."
            retry_command gh issue close "$ISSUE_NUMBER" --comment "‚úÖ Aggiornamento completato con successo! Tutte le statistiche sono state aggiornate e le PR sono state mergiate."
            echo "‚úÖ Issue #$ISSUE_NUMBER closed successfully"
          else
            echo "‚ö†Ô∏è No issue number found to close"
          fi
